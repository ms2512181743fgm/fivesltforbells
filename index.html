<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Let’s Match b/e/l/l/e!</title>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background: #000;
    font-size: 24px;
    margin: 0;
    padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  h1 {
    margin: 10px 0;
    font-size: 40px;
    color: magenta;
  }

  /* ▼ 5列リール＋窓枠まとめ */
  .slot-wrapper {
    position: relative;
    width: fit-content;
    margin: 0 auto;
  }

  /* ▼ リール部分（高さ固定でズレ防止） */
  .reels {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 20px;
    height: 210px;
    margin-bottom: 40px; /* コメントと重ならないように余白 */
  }

  .reel {
    width: 140px;
    height: 210px;
    overflow: hidden;
    border: 4px solid #333;
    border-radius: 12px;
    background-image: url("slt265x1325.png");
    background-repeat: repeat-y;
    background-size: 140px 700px;
  }

  /* ▼ 窓枠画像（ズレ修正） */
  .slot-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -55%); /* ★ 少し上に持ち上げる */
    pointer-events: none;
  }

  /* ▼ ボタン画像 */
  .stop-btn {
    width: 57px;
    height: 57px;
    margin-top: 5px;
    user-select: none;
  }

  .stop-btn.disabled {
    pointer-events: none;
    opacity: 0.5;
  }

  /* ▼ 揃った瞬間の白フラッシュ（窓枠画像） */
  .flash-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 780px;
    transform: translate(-50%, -55%); /* ★ 枠と同じ位置に */
    opacity: 0;
    pointer-events: none;
    animation: flashFrame 0.35s ease-out forwards;
  }

  @keyframes flashFrame {
    0%   { opacity: 0; }
    40%  { opacity: 1; }
    100% { opacity: 0; }
  }

  /* ▼ 大当たり時のループ光（白→マゼンタ→金→マゼンタ） */
  .win-glow {
    position: absolute;
    top: 50%;
    left: 50%;
    width: 780px;
    transform: translate(-50%, -55%); /* ★ 枠と同じ位置に */
    pointer-events: none;
    opacity: 0.8;
    animation: winGlow 3s linear infinite;
  }

  @keyframes winGlow {
    0%   { filter: drop-shadow(0 0 25px rgba(255,255,255,0.7)); }
    25%  { filter: drop-shadow(0 0 25px rgba(255,0,255,0.7)); }
    50%  { filter: drop-shadow(0 0 25px rgba(255,215,0,0.7)); }
    75%  { filter: drop-shadow(0 0 25px rgba(255,0,255,0.7)); }
    100% { filter: drop-shadow(0 0 25px rgba(255,255,255,0.7)); }
  }

  #excellent {
    font-size: 120px;
    color: rgba(255,0,255,0.9);
    display: none;
    position: fixed;
    top: 45%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  /* ▼ コメント位置をさらに下げる */
  #resultText {
    font-size: 40px;
    color: magenta;
    min-height: 50px;
    margin-top: 70px; /* ★ 40 → 70 に変更（STARTの半分くらい下へ） */
  }

  /* ▼ START ボタンは前回のまま（位置変更なし） */
  #startBtn {
    padding: 10px 25px;
    font-size: 26px;
    color: magenta;
    border: 3px solid magenta;
    background: #fff;
    border-radius: 10px;
    cursor: pointer;
    margin: 60px auto 20px;
  }
</style>
</head>
<body>

<h1>Let’s Match b/e/l/l/e!</h1>

<div class="slot-wrapper" id="slotWrapper">
  <div class="reels" id="reels"></div>
  <img class="slot-frame" id="slotFrame" src="slt_waku_1560x450.png">
</div>

<div id="excellent">EXCELLENT!!</div>
<div id="resultText"></div>

<button id="startBtn">START</button>

<script>
/* 基本設定 */
const REELS = 5;
const oneHeight = 140;
const totalHeight = 700;
const frameHeight = 210;
const centerOffset = (frameHeight - oneHeight) / 2;

const baseMaxSpeed = 14.4;
const accelDuration = 2000;

let reels = [];
let speeds = Array(REELS).fill(0);
let positions = [560, 420, 280, 140, 0];
let spinning = Array(REELS).fill(false);
let stopped = Array(REELS).fill(false);

let winGlowImg = null;

const reelsContainer = document.getElementById("reels");
const slotWrapper = document.getElementById("slotWrapper");
const slotFrame = document.getElementById("slotFrame");
const startBtn = document.getElementById("startBtn");
const excellent = document.getElementById("excellent");
const resultText = document.getElementById("resultText");

const symbols = ["e", "l", "l", "e", "b"];
const correctPattern = ["b","e","l","l","e"];

/* 背景位置を中央揃えで更新 */
function updateReelPosition(i) {
  reels[i].reelDiv.style.backgroundPositionY =
    (-positions[i] + centerOffset) + "px";
}

/* ボタン状態切り替え */
function enableButton(i) {
  const btn = reels[i].stopBtn;
  btn.classList.remove("disabled");
  btn.src = "btn_enabled.png";
}

function disableButton(i) {
  const btn = reels[i].stopBtn;
  btn.classList.add("disabled");
  btn.src = "btn_unenabled.png";
}

/* 窓枠を白フラッシュ */
function flashFrame() {
  const img = document.createElement("img");
  img.src = "slt_waku_1560x450.png";
  img.className = "flash-frame";
  slotWrapper.appendChild(img);
  setTimeout(() => img.remove(), 400);
}

/* 大当たりループ光 */
function startWinGlow() {
  winGlowImg = document.createElement("img");
  winGlowImg.src = "slt_waku_1560x450.png";
  winGlowImg.className = "win-glow";
  slotWrapper.appendChild(winGlowImg);
}

function stopWinGlow() {
  if (winGlowImg) {
    winGlowImg.remove();
    winGlowImg = null;
  }
}

/* belle の成立可能性チェック */
function canStillBecomeBelle(lastIndex) {
  for (let i = 0; i <= lastIndex; i++) {
    const sym = symbols[Math.floor(positions[i] / oneHeight)];
    if (sym !== correctPattern[i]) return false;
  }
  return true;
}

/* リール生成 */
for (let i = 0; i < REELS; i++) {
  const reelDiv = document.createElement("div");
  reelDiv.className = "reel";

  const stopBtn = document.createElement("img");
  stopBtn.className = "stop-btn disabled";
  stopBtn.src = "btn_unenabled.png";

  stopBtn.addEventListener("touchstart", e => {
    e.preventDefault();
    if (!stopBtn.classList.contains("disabled")) stopReel(i);
  });

  stopBtn.addEventListener("mousedown", () => {
    if (!stopBtn.classList.contains("disabled")) stopReel(i);
  });

  const wrapper = document.createElement("div");
  wrapper.style.textAlign = "center";
  wrapper.appendChild(reelDiv);
  wrapper.appendChild(stopBtn);

  reelsContainer.appendChild(wrapper);

  reels.push({ reelDiv, stopBtn });
  updateReelPosition(i);
}

/* 窓枠画像をスロット全体の幅に合わせる */
function resizeFrame() {
  slotFrame.style.width = slotWrapper.offsetWidth + "px";
}
resizeFrame();
window.addEventListener("resize", resizeFrame);

/* START */
function startGame() {
  stopWinGlow();

  document.querySelectorAll(".flash-frame").forEach(e => e.remove());

  for (let i = 0; i < REELS; i++) {
    disableButton(i);
    spinning[i] = false;
    stopped[i] = true;
    speeds[i] = 0;

    const snap = Math.round(positions[i] / oneHeight) * oneHeight;
    positions[i] = snap % totalHeight;
    updateReelPosition(i);
  }

  startBtn.style.display = "none";
  excellent.style.display = "none";
  resultText.textContent = "";

  speeds.fill(0);
  spinning.fill(true);
  stopped.fill(false);

  reels.forEach((_, i) => {
    setTimeout(() => accelerate(i), i * 100);
  });
}

startBtn.onclick = startGame;

/* 加速 */
function accelerate(index) {
  const startTime = performance.now();

  function step(now) {
    if (!spinning[index]) return;

    const t = Math.min((now - startTime) / accelDuration, 1);
    speeds[index] = baseMaxSpeed * (1 - Math.pow(2, -10 * t));

    positions[index] = (positions[index] - speeds[index] + totalHeight) % totalHeight;
    updateReelPosition(index);

    if (t < 1) {
      requestAnimationFrame(step);
    } else {
      speeds[index] = baseMaxSpeed;
      if (index === 0) enableButton(0);
      requestAnimationFrame(() => spinLoop(index));
    }
  }

  requestAnimationFrame(step);
}

/* 回転ループ */
function spinLoop(index) {
  if (!spinning[index] || stopped[index]) return;

  positions[index] = (positions[index] - speeds[index] + totalHeight) % totalHeight;
  updateReelPosition(index);

  requestAnimationFrame(() => spinLoop(index));
}

/* 停止（ラグなし・条件付きフラッシュ） */
function stopReel(index) {
  if (stopped[index]) return;

  stopped[index] = true;
  spinning[index] = false;
  disableButton(index);

  positions[index] = (positions[index] - speeds[index] * 1.2 + totalHeight) % totalHeight;
  positions[index] = Math.round(positions[index] / oneHeight) * oneHeight % totalHeight;

  updateReelPosition(index);

  if (canStillBecomeBelle(index)) {
    flashFrame();
  }

  checkAllStopped();

  if (index + 1 < REELS) enableButton(index + 1);
}

/* 揃い判定 */
function checkAllStopped() {
  if (!stopped.every(v => v)) return;

  const result = positions.map(p => symbols[Math.floor(p / oneHeight)]);
  const joined = result.join("");

  if (joined === "belle") {
    resultText.textContent = "大当たり！";
    excellent.style.display = "block";
    startWinGlow();
  } else {
    resultText.textContent = "残念.....";
    excellent.style.display = "none";
  }

  startBtn.style.display = "inline-block";
}
</script>

</body>
</html>
