<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Let’s Match b/e/l/l/e!</title>

<style>
  body {
    font-family: sans-serif;
    text-align: center;
    background: #000;
    font-size: 24px;
    margin: 0;
    padding: env(safe-area-inset-top) 20px env(safe-area-inset-bottom);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  h1 {
    margin: 10px 0;
    font-size: 40px;
    color: magenta;
  }

  /* ▼ 5列リール＋窓枠まとめ */
  .slot-wrapper {
    position: relative;
    width: fit-content;
    margin: 0 auto;
  }

  /* ▼ リール部分（高さ固定でズレ防止） */
  .reels {
    position: relative;
    display: flex;
    justify-content: center;
    gap: 20px;
    height: 210px;
    margin-bottom: 10px;
  }

  .reel {
    width: 140px;
    height: 210px;
    overflow: hidden;
    border: 4px solid #333;
    border-radius: 12px;
    background-image: url("slt265x1325.png");
    background-repeat: repeat-y;
    background-size: 140px 700px;
  }

  /* ▼ 窓枠画像（5列まとめて） */
  .slot-frame {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
  }

  /* ▼ ボタン画像 */
  .stop-btn {
    width: 57px;
    height: 57px;
    margin-top: 5px;
    user-select: none;
  }

  .stop-btn.disabled {
    pointer-events: none;
    opacity: 0.5;
  }

  /* ▼ 光エフェクト（単発） */
  .glow {
    position: absolute;
    top: 0;
    left: 0;
    width: 140px;
    height: 210px;
    border-radius: 12px;
    pointer-events: none;
    opacity: 0;
    animation: glowFlash 0.45s ease-out forwards;
  }

  @keyframes glowFlash {
    0%   { opacity: 0; }
    30%  { opacity: 1; }
    100% { opacity: 0; }
  }

  /* ▼ 全揃いループ光 */
  .glow-loop {
    position: absolute;
    top: 0;
    left: 0;
    width: 140px;
    height: 210px;
    border-radius: 12px;
    pointer-events: none;
    animation: glowLoop 1.2s ease-in-out infinite;
  }

  @keyframes glowLoop {
    0%   { opacity: 0.2; }
    50%  { opacity: 1; }
    100% { opacity: 0.2; }
  }

  #excellent {
    font-size: 120px;
    color: rgba(255,0,255,0.9);
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  #resultText {
    font-size: 40px;
    color: magenta;
    min-height: 50px;
  }

  #startBtn {
    padding: 10px 25px;
    font-size: 26px;
    color: magenta;
    border: 3px solid magenta;
    background: #fff;
    border-radius: 10px;
    cursor: pointer;
    margin: 10px auto;
  }
</style>
</head>
<body>

<h1>Let’s Match b/e/l/l/e!</h1>

<div class="slot-wrapper" id="slotWrapper">
  <div class="reels" id="reels"></div>
  <img class="slot-frame" id="slotFrame" src="slt_waku_1560x450.png">
</div>

<div id="excellent">EXCELLENT!!</div>
<div id="resultText"></div>

<button id="startBtn">START</button>

<script>
/* 基本設定 */
const REELS = 5;
const oneHeight = 140;
const totalHeight = 700;
const frameHeight = 210;
const centerOffset = (frameHeight - oneHeight) / 2;

const baseMaxSpeed = 14.4;
const accelDuration = 2000;

let reels = [];
let speeds = Array(REELS).fill(0);
let positions = [560, 420, 280, 140, 0];
let spinning = Array(REELS).fill(false);
let stopped = Array(REELS).fill(false);

const reelsContainer = document.getElementById("reels");
const slotWrapper = document.getElementById("slotWrapper");
const slotFrame = document.getElementById("slotFrame");
const startBtn = document.getElementById("startBtn");
const excellent = document.getElementById("excellent");
const resultText = document.getElementById("resultText");

const messages = {
  "belle": { text: "大当たり！", excellent: true },
  "beeee": { text: "べーーー", excellent: false },
  "leeee": { text: "りーーー", excellent: false },
  "bbbbb": { text: "bを揃えた、しかし何も起こらなかった...", excellent: false },
  "eeeee": { text: "eを揃えた、しかし何も起こらなかった...", excellent: false },
  "lllll": { text: "lを揃えた、しかし何も起こらなかった...", excellent: false },
  "elleb": { text: "右からやって来たね！", excellent: true }
};

const symbols = ["e", "l", "l", "e", "b"];

/* ▼ ランダムグラデーション生成 */
function randomGradient() {
  const angle = Math.floor(Math.random() * 360);
  const stop1 = Math.floor(Math.random() * 40) + 10;  // 10〜50%
  const stop2 = stop1 + Math.floor(Math.random() * 40) + 20; // stop1+20〜stop1+60

  return `linear-gradient(${angle}deg,
    magenta ${stop1}%,
    gold ${stop2}%
  )`;
}

/* ▼ 背景位置を中央揃えで更新 */
function updateReelPosition(i) {
  reels[i].reelDiv.style.backgroundPositionY =
    (-positions[i] + centerOffset) + "px";
}

/* ▼ ボタン状態切り替え */
function enableButton(i) {
  const btn = reels[i].stopBtn;
  btn.classList.remove("disabled");
  btn.src = "btn_enabled.png";
}

function disableButton(i) {
  const btn = reels[i].stopBtn;
  btn.classList.add("disabled");
  btn.src = "btn_unenabled.png";
}

/* ▼ 光演出（単発） */
function flashIfCorrect(index) {
  const symbol = symbols[Math.floor(positions[index] / oneHeight)];
  const correct = ["b","e","l","l","e"][index];

  if (symbol === correct) {
    const glow = document.createElement("div");
    glow.className = "glow";
    glow.style.background = randomGradient();
    reels[index].reelDiv.parentElement.appendChild(glow);
    setTimeout(() => glow.remove(), 500);
  }
}

/* ▼ リール生成 */
for (let i = 0; i < REELS; i++) {
  const reelDiv = document.createElement("div");
  reelDiv.className = "reel";

  const stopBtn = document.createElement("img");
  stopBtn.className = "stop-btn disabled";
  stopBtn.src = "btn_unenabled.png";

  stopBtn.onclick = () => {
    if (!stopBtn.classList.contains("disabled")) stopReel(i);
  };

  const wrapper = document.createElement("div");
  wrapper.style.textAlign = "center";
  wrapper.appendChild(reelDiv);
  wrapper.appendChild(stopBtn);

  reelsContainer.appendChild(wrapper);

  reels.push({ reelDiv, stopBtn });
  updateReelPosition(i);
}

/* ▼ 窓枠画像をスロット全体の幅に合わせる */
function resizeFrame() {
  slotFrame.style.width = slotWrapper.offsetWidth + "px";
}
resizeFrame();
window.addEventListener("resize", resizeFrame);

/* ▼ START */
function startGame() {
  document.querySelectorAll(".glow-loop").forEach(e => e.remove());

  for (let i = 0; i < REELS; i++) {
    disableButton(i);
    spinning[i] = false;
    stopped[i] = true;
    speeds[i] = 0;

    const snap = Math.round(positions[i] / oneHeight) * oneHeight;
    positions[i] = snap % totalHeight;
    updateReelPosition(i);
  }

  startBtn.style.display = "none";
  excellent.style.display = "none";
  resultText.textContent = "";

  speeds.fill(0);
  spinning.fill(true);
  stopped.fill(false);

  reels.forEach((_, i) => {
    setTimeout(() => accelerate(i), i * 100);
  });
}

startBtn.onclick = startGame;

/* ▼ 加速 */
function accelerate(index) {
  const startTime = performance.now();

  function step(now) {
    if (!spinning[index]) return;

    const t = Math.min((now - startTime) / accelDuration, 1);
    speeds[index] = baseMaxSpeed * (1 - Math.pow(2, -10 * t));

    positions[index] = (positions[index] - speeds[index] + totalHeight) % totalHeight;
    updateReelPosition(index);

    if (t < 1) {
      requestAnimationFrame(step);
    } else {
      speeds[index] = baseMaxSpeed;
      if (index === 0) enableButton(0);
      requestAnimationFrame(() => spinLoop(index));
    }
  }

  requestAnimationFrame(step);
}

/* ▼ 回転ループ */
function spinLoop(index) {
  if (!spinning[index] || stopped[index]) return;

  positions[index] = (positions[index] - speeds[index] + totalHeight) % totalHeight;
  updateReelPosition(index);

  requestAnimationFrame(() => spinLoop(index));
}

/* ▼ 停止（ラグなし） */
function stopReel(index) {
  if (stopped[index]) return;

  stopped[index] = true;
  spinning[index] = false;
  disableButton(index);

  positions[index] = (positions[index] - speeds[index] * 1.2 + totalHeight) % totalHeight;
  positions[index] = Math.round(positions[index] / oneHeight) * oneHeight % totalHeight;

  updateReelPosition(index);

  let shake = 15;
  function shakeAnim() {
    reels[index].reelDiv.style.backgroundPositionY =
      (-positions[index] + centerOffset + shake) + "px";

    shake *= -0.4;

    if (Math.abs(shake) > 1) {
      requestAnimationFrame(shakeAnim);
    } else {
      updateReelPosition(index);
      flashIfCorrect(index);
      checkAllStopped();
    }
  }
  shakeAnim();

  if (index + 1 < REELS) enableButton(index + 1);
}

/* ▼ 揃い判定 */
function checkAllStopped() {
  if (!stopped.every(v => v)) return;

  const result = positions.map(p => symbols[Math.floor(p / oneHeight)]);
  const joined = result.join("");

  if (messages[joined]) {
    resultText.textContent = messages[joined].text;
    excellent.style.display = messages[joined].excellent ? "block" : "none";

    if (joined === "belle") {
      for (let i = 0; i < REELS; i++) {
        const loop = document.createElement("div");
        loop.className = "glow-loop";
        loop.style.background = randomGradient();
        reels[i].reelDiv.parentElement.appendChild(loop);
      }
    }
  } else {
    resultText.textContent = "残念.....";
    excellent.style.display = "none";
  }

  startBtn.style.display = "inline-block";
}
</script>

</body>
</html>
